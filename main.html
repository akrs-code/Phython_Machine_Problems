<!DOCTYPE html>
<html>
<head>
  <title>Luntian Mock Exam Pilot Test v.6.</title>
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .slide {
      display: none;
      margin-bottom: 20px;
      padding: 20px;
      border: 1px solid #ccc;
      width: 80%;
      max-width: 600px;
      box-sizing: border-box;
    }
    .slide.active {
      display: block;
    }
    .options label {
      display: block;
      margin-bottom: 5px;
    }
    #navigation {
      margin-top: 20px;
      text-align: center;
    }
    #timer {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }
    #termination-message {
      display: none;
      color: red;
      font-weight: bold;
      font-size: 1.5em;
      text-align: center;
      margin-top: 20px;
    }
    #info-input-slide {
      text-align: center;
    }
    #info-input-slide label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }
    #studentName, #studentID {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 50%;
      margin-bottom: 15px;
    }
    #qrcode {
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>

<div id="timer">Time Remaining: 1:00:00</div>

<form id="quizForm">
  <div class="slide active" id="info-input-slide">
    <h1>Luntian Mock Exam Pilot Test v.6.</h1>
    <label for="studentName">Enter Your Name:</label>
    <input type="text" id="studentName" name="studentName" placeholder="Your Name">
    <label for="studentID">Enter Your Student ID:</label>
    <input type="text" id="studentID" name="studentID" placeholder="Your Student ID">
    <button type="button" onclick="nextSlide()">Start Quiz</button>
  </div>

  <div class="slide">
    <p>1. What is the capital of France?</p>
    <div class="options">
      <label><input type="radio" name="q1" value="a">A. Berlin</label>
      <label><input type="radio" name="q1" value="b">B. Madrid</label>
      <label><input type="radio" name="q1" value="c">C. Paris</label>
      <label><input type="radio" name="q1" value="d">D. Rome</label>
    </div>
  </div>

  <div class="slide">
    <p>2. What is the chemical symbol for water?</p>
    <div class="options">
      <label><input type="radio" name="q2" value="a">A. Co</label>
      <label><input type="radio" name="q2" value="b">B. H2O</label>
      <label><input type="radio" name="q2" value="c">C. O2</label>
      <label><input type="radio" name="q2" value="d">D. NaCl</label>
    </div>
  </div>

  <!-- Add more questions here -->

  <div id="navigation" style="display: none;">
    <button type="button" id="prevBtn" onclick="prevSlide()" disabled>Previous</button>
    <button type="button" id="nextBtn" onclick="nextSlide()">Next</button>
    <button type="submit" style="display: none;">Submit Quiz</button>
  </div>
</form>

<div id="results" style="display: none;">
  <div id="qrcode"></div>
</ div>
<div id="termination-message" style="display: none;">Quiz Terminated Due to Focus Loss.</div>

<script>
  const timerDisplay = document.getElementById('timer');
  const form = document.getElementById('quizForm');
  const slides = document.querySelectorAll('.slide');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const submitBtn = document.querySelector('#navigation button[type="submit"]');
  const resultsDiv = document.getElementById('results');
  const terminationMessageDiv = document.getElementById('termination-message');
  const navigationDiv = document.getElementById('navigation');
  const nameInput = document.getElementById('studentName');
  const idInput = document.getElementById('studentID');
  let currentSlide = 0;
  let numSlides = slides.length;
  const answers = {
    q1: 'c',
    q2: 'b'
    // Add correct answers for all 100 questions here
  };
  let timeLeft = 3600; // 1 hour in seconds
  let timerInterval;
  const body = document.body;
  let quizActive = true; // Flag to track if the quiz is active
  let studentName = "";
  let studentID = "";
  let startTime;
  let endTime;
  let attemptNumber = 1; // Default to 1

  function requestFullScreen() {
    if (body.requestFullscreen) {
      body.requestFullscreen();
    } else if (body.mozRequestFullScreen) { /* Firefox */
      body.mozRequestFullScreen();
    } else if (body.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
      body.webkitRequestFullscreen();
    } else if (body.msRequestFullscreen) { /* IE/Edge */
      body.msRequestFullscreen();
    }
  }

  function terminateQuiz() {
    quizActive = false;
    clearInterval(timerInterval);
    form.style.display = 'none';
    resultsDiv.style.display = 'none';
    terminationMessageDiv.style.display = 'block';
    timerDisplay.style.display = 'none';
    navigationDiv.style.display = 'none';
    endTime = new Date(); // Record end time on termination
  }

  window.addEventListener('blur', function() {
    if (quizActive && currentSlide > 0) { // Only terminate if past the info input
      terminateQuiz();
    }
  });

  function updateTimer() {
    if (!quizActive) return; // Stop timer updates if quiz is terminated

    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    timerDisplay.textContent = `Time Remaining: ${formattedTime}`;
    timeLeft--;

    if (timeLeft < 0 && quizActive) {
      clearInterval(timerInterval);
      form.dispatchEvent(new Event('submit')); // Trigger form submission
      timerDisplay.textContent = "Time's Up!";
      endTime = new Date(); // Record end time on timeout
    }
  }

  function startTimer() {
    startTime = new Date(); // Record start time
    timerInterval = setInterval(updateTimer, 1000);
  }

  function showSlide(n) {
    if (!quizActive) return; // Prevent navigation if quiz is terminated

    slides.forEach(slide => slide.classList.remove('active'));
    slides[n].classList.add('active');
    currentSlide = n;

    // Hide navigation on the info input slide
    if (currentSlide === 0) {
      navigationDiv.style.display = 'none';
    } else {
      navigationDiv.style.display = 'block';
    }

    if (currentSlide === 0) {
      prevBtn.disabled = true;
      nextBtn.style.display = 'inline-block'; // Changed to inline-block for the "Start Quiz" button
      submitBtn.style.display = 'none';
    } else if (currentSlide === numSlides - 1) {
      nextBtn.style.display = 'none';
      submitBtn.style.display = 'inline-block';
      prevBtn.disabled = false;
    } else {
      prevBtn.disabled = false;
      nextBtn.style.display = 'inline-block';
      submitBtn.style.display = 'none';
    }
  }

  function nextSlide() {
    if (!quizActive) return;
    if (currentSlide < numSlides - 1) {
      if (currentSlide === 0) {
        studentName = nameInput.value.trim();
        studentID = idInput.value.trim();
        if (studentName === "" || studentID === "") {
          alert("Please enter your name and student ID to start the quiz.");
          return;
        }
        startTimer(); // Start the timer after the information is entered
        randomizeQuestionsAndAnswers(); // Randomize questions and answers
      }
      showSlide(currentSlide + 1);
    }
  }

  function prevSlide() {
    if (!quizActive) return;
    if (currentSlide > 0) {
      showSlide(currentSlide - 1);
      if (currentSlide === 1) {
        clearInterval(timerInterval); // Optionally stop timer if going back to info input
        timeLeft = 3600; // Reset timer
        timerDisplay.textContent = "Time Remaining: 1:00:00";
      }
    }
  }

  form.addEventListener('submit', function(event) {
    event.preventDefault();
    if (!quizActive) return;

    clearInterval(timerInterval); // Stop the timer when the form is submitted
    endTime = new Date(); // Record end time on manual submission

    // Increment attempt number in local storage
    let attempts = localStorage.getItem('quizAttempts') || 0;
    attempts = parseInt(attempts) + 1;
    localStorage.setItem('quizAttempts', attempts);
    attemptNumber = attempts;

    let score = 0;
    const formData = new FormData(form);
    const totalPoints = numSlides - 1; // Total number of questions (excluding the info slide)
    const dateTaken = new Date().toLocaleDateString();
    const startTimeFormatted = startTime ? startTime.toLocaleTimeString() : 'N/A';
    const endTimeFormatted = endTime ? endTime.toLocaleTimeString() : 'N/A';

    // Calculate duration
    const durationMs = endTime ? endTime.getTime() - startTime.getTime() : 0;
    const durationSeconds = Math.floor(durationMs / 1000);
    const durationMinutes = Math.floor(durationSeconds / 60);
    const remainingSeconds = durationSeconds % 60;
    const examDuration = `${durationMinutes} minutes and ${remainingSeconds} seconds`;

    let resultsHTML = `<h2>Quiz Results</h2><p>Name: ${studentName}</p><p>Student ID: ${studentID}</p>`;
    resultsHTML += `<p>Attempt Number: ${attemptNumber}</p>`;
    resultsHTML += `<p>Date Taken: ${dateTaken}</p>`;
    resultsHTML += `<p>Start Time: ${startTimeFormatted}</p>`;
    resultsHTML += `<p>End Time: ${endTimeFormatted}</p>`;
    resultsHTML += `<p>Exam Duration: ${examDuration}</p>`;
    resultsHTML += `<p>Score: ${score} / ${totalPoints}</p><h3>Correct Answers:</h3><ol>`;

    // Data for QR code
    const qrData = JSON.stringify({
      studentName: studentName,
      studentID: studentID,
      totalPoints: totalPoints,
      score: score,
      dateTaken: dateTaken,
      startTime: startTimeFormatted,
      examDuration: examDuration,
      attemptNumber: attemptNumber
    });

    for (let i = 1; i < numSlides; i++) {
      const questionName = `q${i}`;
      const selectedAnswer = formData.get(questionName);
      const correctAnswer = answers[questionName];
      const questionText = slides[i].querySelector('p').textContent; // Get the question text

      resultsHTML += `<li><strong>Question ${i}:</strong> ${questionText}<br>`;
      resultsHTML += `Your Answer: ${selectedAnswer ? selectedAnswer.toUpperCase() : 'Not Answered'}<br>`;
      resultsHTML += `Correct Answer: ${correctAnswer.toUpperCase()}</li>`;

      if (selectedAnswer === correctAnswer) {
        score++;
      }
    }

    resultsHTML += `</ol><div id="qrcode"></div>`; // Ensure the qrcode div is in the results
    resultsDiv.innerHTML = resultsHTML.replace(`<p>Score: 0 / ${totalPoints}</p>`, `<p>Score: ${score} / ${totalPoints}</p>`); // Update score in the HTML

    // Generate QR code
    const qrcodeDiv = document.getElementById('qrcode');
    qrcodeDiv.innerHTML = ''; // Clear any previous QR code
    new QRCode(qrcodeDiv, {
      text: qrData,
      width: 128,
      height: 128
    });

    form.style.display = 'none';
    resultsDiv.style.display = 'block';
    timerDisplay.style.display = 'none';
    navigationDiv.style.display = 'none';
  });

  // Function to shuffle an array
  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i ], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  // Function to randomize questions and answers
  function randomizeQuestionsAndAnswers() {
    const questionSlides = Array.from(slides).slice(1); // Exclude the info input slide
    const randomizedQuestions = shuffle(questionSlides);

    // Clear existing slides
    form.innerHTML = '';
    form.appendChild(document.getElementById('info-input-slide')); // Add the info input slide back

    // Append randomized questions to the form
    randomizedQuestions.forEach((slide, index) => {
      const questionIndex = index + 1; // Adjust index for question numbering
      slide.querySelector('p').textContent = `${questionIndex}. ${slide.querySelector('p').textContent.split('. ')[1]}`; // Update question number
      const options = Array.from(slide.querySelectorAll('.options label'));
      const randomizedOptions = shuffle(options);

      // Clear existing options and append randomized options
      const optionsContainer = slide.querySelector('.options');
      optionsContainer.innerHTML = '';
      randomizedOptions.forEach(option => optionsContainer.appendChild(option));

      form.appendChild(slide);
    });

    // Update the number of slides
    currentSlide = 0;
    numSlides = form.querySelectorAll('.slide').length;
    showSlide(currentSlide); // Show the first slide
  }

  // On page load, get the current attempt number from local storage
  let initialAttempts = localStorage.getItem('quizAttempts') || 0;
  attemptNumber = parseInt(initialAttempts) + 1; // Assume this is the next attempt

  // Initialize the quiz
  showSlide(0);
  // requestFullScreen(); // Keep full-screen request
</script>

</body>
</html>
